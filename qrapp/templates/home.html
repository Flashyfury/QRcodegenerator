{% extends 'base.html' %}
{% block content %}

<div class="row">
  <div class="col-md-6">
    <h3>Generate QR</h3>

    <form method="post" enctype="multipart/form-data" id="qr-form">
      {% csrf_token %}
      {{ form.as_p }}

      <button class="btn btn-primary" type="submit">
        Generate & Save
      </button>

      <small class="form-text text-muted">
        If not logged in, saving requires login.
      </small>
    </form>
  </div>

  <div class="col-md-6">
    <h3>Live Scannable Preview</h3>

    <div id="preview-area" style="width:100%;max-width:350px">
      <canvas id="preview-canvas" width="300" height="300"
        style="border:1px solid #ddd; background:white;"></canvas>
    </div>

    <div class="mt-2">
      <a id="download-preview" class="btn btn-secondary" download="qr_preview.png">
        Download Preview
      </a>
    </div>
  </div>
</div>

<script>
const form = document.getElementById("qr-form");
const canvas = document.getElementById("preview-canvas");
const ctx = canvas.getContext("2d");
const downloadBtn = document.getElementById("download-preview");

function updatePreview(){
    const data = new FormData(form);

    fetch("/live-preview/", { method:"POST", body:data })
      .then(r=>r.json())
      .then(res=>{
        const img = new Image();
        img.onload = ()=>{
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(img,0,0);
          downloadBtn.href = canvas.toDataURL("image/png");
        };
        img.src = res.image;
      });
}

form.addEventListener("input", updatePreview);
updatePreview();
</script>

{% endblock %}
